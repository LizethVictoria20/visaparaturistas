<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <style>
    /* Estilos independientes para la tabla de usuarios */
    .user-table {
      width: 100%;
      border-collapse: collapse;
    }
    .user-table th,
    .user-table td {
      border: 1px solid #dee2e6;
      padding: 8px;
      text-align: left;
    }
    .user-table th {
      background-color: #2e3b4f;
    }
    .user-table td {
      background-color: #ffffff;
    }
    .custom-btn {
      background-color: #3c5171 !important;
      color: white !important;
    }
    .btn-delete_user {
      width: 42%;
    }
    .form-delete_user {
      width: 42%;
    }
    .modal-delete_user {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
  <body>
    {% include 'base.html' %} {% block content %}
    <div class="container">
      <h2 class="text-center">Panel administrador</h2>
      <div class="user-info mb-4">
        <div class="user-info-item">
          <i class="fas fa-user"></i>
          <span class="data">Nombre: </span>
          <span id="nombre"> {{ current_user.name }}</span>
        </div>
        <div class="user-info-item">
          <i class="fas fa-user"></i>
          <span class="data">Username: </span>
          <span id="username"> {{ current_user.username }}</span>
        </div>
        <div class="user-info-item">
          <i class="fas fa-envelope"></i>
          <span class="data">Email: </span>
          <span id="email"> {{ current_user.email }}</span>
        </div>
      </div>
      <!-- Acordeón para agregar usuario -->
      <div class="">
        <div class="accordion mt-5" id="accordionAddUser">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingAddUser">
              <button
                class="accordion-button custom-btn"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseAddUser"
                aria-expanded="true"
                aria-controls="collapseAddUser"
              >
                Agregar usuario
              </button>
            </h2>
            <div
              id="collapseAddUser"
              class="accordion-collapse collapse"
              aria-labelledby="headingAddUser"
              data-bs-parent="#accordionAddUser"
            >
              <div class="accordion-body">
                <form action="/admin-dashboard" method="POST">
                  <!-- Formulario de agregar usuario -->
                  <div class="form-group">
                    <label for="name">Nombre de Usuario:</label>
                    <input
                      type="text"
                      class="form-control"
                      id="name"
                      name="name"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="username">Username</label>
                    <input
                      type="text"
                      class="form-control"
                      id="username"
                      name="username"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input
                      type="text"
                      class="form-control"
                      id="password"
                      name="password"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="email">Email:</label>
                    <input
                      type="email"
                      class="form-control"
                      id="email"
                      name="email"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="telefono">Teléfono:</label>
                    <input
                      type="tel"
                      class="form-control"
                      id="telefono"
                      name="telefono"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="roles">Rol:</label>
                    <select class="form-control" id="roles" name="roles">
                      <option value="user">Usuario</option>
                      <option value="admin">Administrador</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">
                    Agregar Usuario
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Acordeón para lista de usuarios -->
      <div class="">
        <div class="accordion mt-5" id="accordionUserList">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingUserList">
              <button
                class="accordion-button custom-btn"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseUserList"
                aria-expanded="true"
                aria-controls="collapseUserList"
              >
                Lista de Usuarios
              </button>
            </h2>
            <div
              id="collapseUserList"
              class="accordion-collapse collapse"
              aria-labelledby="headingUserList"
              data-bs-parent="#accordionUserList"
            >
              <div class="accordion-body">
                <!-- Tabla de lista de usuarios -->
                <table class="user-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nombre de Usuario</th>
                      <th>Email</th>
                      <th>Rol</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for user in users %}
                    <tr>
                      <td>{{ user.id }}</td>
                      <td>{{ user.username }}</td>
                      <td>{{ user.email }}</td>
                      <td>
                        {% for role in user.roles %} {{ role.name }}{% if not
                        loop.last %}, {% endif %} {% else %} Sin roles {% endfor
                        %}
                      </td>
                      <td class="text-center">
                        <!-- Botón de actualización de contraseña -->
                        <a
                          href="#"
                          class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#updatePasswordModal{{ user.id }}"
                          >Actualizar Contraseña</a
                        >
                        {% include 'update_password.html' %}

                        <!-- Botón para abrir el modal -->
                        <button
                          type="button"
                          class="btn btn-danger btn-sm btn-delete_user"
                          onclick="openDeleteDialog('{{ user.id }}')"
                        >
                          Eliminar
                        </button>

                        <!-- Formulario oculto para eliminación -->
                        <form
                          id="delete-form-{{ user.id }}"
                          class="form-delete_user form-delete_user"
                          action="/delete_user/{{ user.id }}"
                          method="POST"
                          style="display: none"
                        >
                          <!-- Este formulario será enviado desde el modal -->
                        </form>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal para confirmar la eliminación -->
      <div
        class="dialog-overlay modal-delete_user"
        id="delete-dialog-overlay"
      >
        <div class="dialog bg-white p-4 rounded">
          <h3 class="mb-3">Confirma la eliminación</h3>
          <label for="confirm-delete">Escribe "DELETE" para confirmar:</label>
          <input
            type="text"
            id="confirm-delete"
            class="form-control mb-3"
            name="confirm-delete"
            required
          />
          <input type="hidden" id="delete-user-id" />
          <div class="dialog-buttons">
            <button
              type="button"
              class="btn btn-secondary mb-2"
              onclick="closeDeleteDialog()"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmDeletion()"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
      <!-- Acordeón para cambiar contraseña -->
      <div class="">
        <div class="accordion mt-5" id="accordionChangePassword">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingChangePassword">
              <button
                class="accordion-button custom-btn"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseChangePassword"
                aria-expanded="true"
                aria-controls="collapseChangePassword"
              >
                Cambiar contraseña
              </button>
            </h2>
            <div
              id="collapseChangePassword"
              class="accordion-collapse collapse"
              aria-labelledby="headingChangePassword"
              data-bs-parent="#accordionChangePassword"
            >
              <div class="accordion-body">
                <!-- Formulario de cambio de contraseña -->
                <form
                  method="POST"
                  action="{{ url_for('update_password', user_id=current_user.id) }}"
                >
                  {{ form.hidden_tag() }}
                  <div class="form-group">
                    <label for="new_password">Nueva Contraseña</label>
                    {{ form.new_password(class="form-control") }}
                  </div>
                  <div class="form-group">
                    <label for="confirm_password">Confirmar Contraseña</label>
                    {{ form.confirm_password(class="form-control") }}
                  </div>
                  <button type="submit" class="btn btn-primary">
                    Actualizar
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Función para abrir el modal de eliminación
      function openDeleteDialog(userId) {
        document.getElementById("delete-user-id").value = userId; // Guardar el ID del usuario
        document.getElementById("delete-dialog-overlay").style.display = "flex"; // Mostrar el modal
      }

      // Función para cerrar el modal de eliminación
      function closeDeleteDialog() {
        document.getElementById("delete-dialog-overlay").style.display = "none"; // Ocultar el modal
      }

      // Función para confirmar la eliminación
      function confirmDeletion() {
        const confirmationInput =
          document.getElementById("confirm-delete").value;
        const userId = document.getElementById("delete-user-id").value;

        if (confirmationInput === "DELETE") {
          // Enviar el formulario de eliminación correspondiente
          document.getElementById(`delete-form-${userId}`).submit();
        } else {
          alert('Por favor, escribe "DELETE" para confirmar.'); // Mensaje de error si no se confirma correctamente
        }
      }
      // Al cargar la página, asegurarse de que el modal esté oculto
      window.onload = function () {
        document.getElementById("delete-dialog-overlay").style.display = "none"; // Asegurarse de que el modal esté oculto
      };
    </script>
    {% endblock %}
  </body>
</html>
