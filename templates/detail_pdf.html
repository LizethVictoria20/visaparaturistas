<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Resultado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/detail_pdf.css') }}"> -->
     <link rel="stylesheet" href="../static/css/detail_pdf.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="../graficos/radarChart.js"></script>


    <style>
      /* Global styles */
      :root {
        --main-color: #293492;

      }
      body {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f9f9f9;
        color: #666666;
        font-size: 11px;
      }

      /*General styles*/

      .container {
        max-width: 900px;
        margin: 20px auto;
        padding: 30px;
        background-color: #ffffff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }

      .separator {
        margin: 1rem 0;
      }

      .separator-small {
        width: 20rem;
        margin: 1rem 0;
      }

      h4 {
        color: var(--main-color);
      }

      .subtitles {
        color:var(--main-color);

      }

      /* Header styles */
      .header {
        color: var(--main-color);
        padding-bottom: 20px;
      }

      .header h2 {
        font-size: 26px;
        margin-bottom: 2rem;
        margin-top: 0;
      }

      .header h3 {
        margin-top: 3rem;
        margin-bottom: 0;
      }

      .header p {
        color: #666;
        margin-top: 5px;
      }
      .header-imagePDF {
        width: 100%;
      }

      /*Personal details*/
      .personal-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8rem;
        margin: 2rem 0 2rem 0;
      }

      /* Table styles */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
      }

      table th, table td {
        padding: 12px 15px;
        text-align: left;
      }

      table th {
        letter-spacing: 0.03em;
      }

      table tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      /* Results */
      .probability-result {
        float: right;
      }

      .probability {
        color: #E02784;
        font-size: 14px;
      }

      /* Progress bar styles */
      .progress-section {
        margin-bottom: 30px;
      }

      .progress-label {
        font-weight: bold;
        margin-bottom: 8px;
      }

      .progress-bar {
        position: relative;
        height: 20px;
        width: 100%;
        background-color: #f3f3f3;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-bar-inner {
        height: 100%;
        background-color: #28a745;
        border-radius: 10px 0 0 10px;
        width: 0;
        transition: width 1s ease;
      }

      .progress-percentage {
        position: absolute;
        right: 10px;
        top: 0;
        height: 100%;
        display: flex;
        align-items: center;
        color: #fff;
        font-weight: bold;
      }

      /* Suggestions section */
      .suggestions {
        margin-top: 10rem;
      }

      .suggestions-results {
        background-color: #F3F3F3;
        padding: 20px;
        border-radius: .5rem;
      }

      .suggestions h2 {
        color: #856404;
        margin-bottom: 10px;
      }

      .suggestions p {
        margin-bottom: 10px;
      }

      /* Analysis boxes */
      .analysis-section {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
      }

      .analysis-box {
        background-color: #f8f9fa;
        width: 18%;
        text-align: center;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      .analysis-box h3 {
        margin: 0;
        font-size: 16px;
        margin-bottom: 10px;
        color: #0056b3;
      }

      .analysis-box .score {
        font-weight: bold;
        color: #28a745;
      }

      /* Footer */
      footer {
        text-align: center;
        color: #666;
        padding-top: 20px;
        border-top: 1px solid #ddd;
      }

      footer a {
        color: #0056b3;
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

    </style>
</head>
<body>
    <div class="topbar">
    </div>
    <div class="container">
        <div class="header content-margins">
          <img src="../static/images/navbarPDF.png" alt="" class="header-imagePDF">
          <!-- <img src="{{ url_for('static', filename='images/navbarPDF.png') }} alt="Navbar visa para turistas"> -->
          <hr class="separator">
          <h3>Resultado / Test de perfilamiento con inteligencia artificial</h3>
          <h2>Visa de turismo de EE.UU</h2>
          <p>A continuación, se presentan los resultados del test de perfilamiento para la solicitud de visa de turismo a EE. UU., Este test, creado con inteligencia artificial por nuestra compañía "VisaParaTurista.com" le indicará sus probabilidades de obtener la visa, considerando diferentes factores matemáticos y calificando cada criterio en una escala de 1 a 10. Nuestro objetivo es ayudarle a identificar áreas en las que puede fortalecer su proceso de solicitud. Al final, encontrará consejos útiles y un diagrama para comprender mejor sus oportunidades de mejora. Agradecemos su confianza y esperamos ser de ayuda en su solicitud de visa de turismo a EE. UU.</p>
        </div>
        <hr class="separator">
        <div class="personal-details content-margins">
            <div>
                <p>Nombre del solicitante</p>
                <strong><span id="nombre-span">{{ result.nombre }} {{ result.apellidos }}</span></strong>
            </div>
            <div>
                <p>Fecha del perfilamiento</p>
                <strong><span id="fecha-span">{{ result.fecha }}</span></strong>
            </div>
        </div>
        <hr class="separator-small">
        <h4>1. Preguntas, respuestas y calificacion del test</h4>
        <hr class="separator">

        <table class="questions">
            <tr>
                <th class="subtitles">Pregunta</th>
                <th class="subtitles">Respuesta</th>
                <th class="subtitles">Puntaje</th>
            </tr>
            <tr>
                <td>1 - Edad</td>
                <td>{{ result.edad }}</td>
                <td>{{ result.calificacion_edad_ChatGPT }}</td>
            </tr>
            <tr>
              <td>2 - Estado Civil</td>
              <td>{{ result.estado_civil }}</td>
              <td>{{ result.calificacion_estado_civil_ChatGPT }}</td>
            </tr>
            <tr>
                <td>3 - ¿Cuántos hijos tienes?</td>
                <td>{{ result.hijos }}</td>
                <td>{{ result.calificacion_hijos_ChatGPT }}</td>
            </tr>
            <tr>
                <td>4 - ¿Con quién comparte su vivienda actualmente?</td>
                <td>{{ result.vivienda }}</td>
                <td>{{ result.calificacion_vivienda_ChatGPT }}</td>
            </tr>
            <tr>
              <td>5 - Profesión u ocupación</td>
              <td>{{ result.profesion }}</td>
              <td>{{ result.calificacion_profesion_ChatGPT }}</td>
          </tr>
          <tr>
            <td>6 - ¿Cuál es su nivel de educación?</td>
            <td>{{ result.nivel_educacion }}</td>
            <td>{{ result.calificacion_nivel_educacion_ChatGPT }}</td>
          </tr>
          <tr>
            <td>7 - ¿Cuánto tiempo lleva trabajando en su empleo actual?</td>
            <td>{{ result.tiempo_empleo }}</td>
            <td>{{ result.calificacion_tiempo_empleo_ChatGPT }}</td>
          </tr>
          <tr>
            <td>8 - ¿Es propietario o socio de alguna empresa?</td>
            <td>{{ result.propietario }}</td>
            <td>{{ result.calificacion_propietario_ChatGPT }}</td>
          </tr>
          <tr>
            <td>9 - Ingresos mensuales aproximados en dólares americanos</td>
            <td>{{ result.ingresos }}</td>
            <td>{{ result.calificacion_ingresos_ChatGPT }}</td>
          </tr>
          <tr>
            <td>10 - ¿Paga impuestos y no participa en programas de asistencia social?</td>
            <td>{{ result.impuestos }}</td>
            <td>{{ result.calificacion_impuestos_ChatGPT }}</td>
          </tr>
          <tr>
            <td>11 - ¿Posee propiedades inmobiliarias y/o vehículos en su país de residencia?</td>
            <td>{{ result.propiedades }}</td>
            <td>{{ result.calificacion_propiedades_ChatGPT }}</td>
          </tr>
          <tr>
            <td>12 - ¿En los últimos 5 años, a qué países ha viajado?</td>
            <td>{{ result.viajes }}</td>
            <td>{{ result.calificacion_viajes_ChatGPT }}</td>
          </tr>
          <tr>
            <td>13 - ¿Tiene familiares que residan en los Estados Unidos?</td>
            <td>{{ result.familiares_eeuu }}</td>
            <td>{{ result.calificacion_familiares_eeuu_ChatGPT }}</td>
          </tr>
          <tr>
            <td>14 - ¿Tiene familiares que cuenten con una visa de turismo a EE.UU.?</td>
            <td>{{ result.familiares_visa }}</td>
            <td>{{ result.calificacion_familiares_visa_ChatGPT }}</td>
          </tr>
          <tr>
            <td>15 - ¿Le ha sido negada una visa de turismo para EE.UU. anteriormente?</td>
            <td>{{ result.visa_negada }}</td>
            <td>{{ result.calificacion_visa_negada_ChatGPT }}</td>
          </tr>
          <tr>
            <td>16 - ¿Tiene antecedentes judiciales o ha estado en procesos de embargo?</td>
            <td>{{ result.antecedentes }}</td>
            <td>{{ result.calificacion_antecedentes_ChatGPT }}</td>
          </tr>
          <tr>
            <td>17 - ¿Padece alguna enfermedad crónica o preexistente de base?</td>
            <td>{{ result.enfermedades }}</td>
            <td>{{ result.calificacion_enfermedades_ChatGPT }}</td>
          </tr>
          <tr>
            <td>18 - ¿Tiene algún tipo de visa o permiso de residencia vigente para otro país?</td>
            <td>{{ result.visa_otra }}</td>
            <td>{{ result.calificacion_visa_otra_ChatGPT }}</td>
          </tr>
          <tr>
            <td>19 - ¿Ha tenido problemas o dificultades con las autoridades migratorias?</td>
            <td>{{ result.problemas_migratorios }}</td>
            <td>{{ result.calificacion_problemas_migratorios_ChatGPT }}</td>
          </tr>
          <tr>
            <td>20 - Criterios confidenciales del sistema</td>
            <td>------------------</td>
            <td>{{ result.calificacion_criterios_confidenciales_ChatGPT }}</td>
          </tr>
        </table>

        <div class="probability-result">
          <hr class="separator-small">
          <strong class="subtitles"><p>Probabilidad de aprobación de visa de turismo d EE.UU</p></strong>
          <strong class="probability">{{ result.probabilidad }}%</strong>
        </div>
 

        <div class="suggestions">
          <hr class="separator-small">
          <h3 class="subtitles">2. Sugerencias para mejorar su perfil</h3>
          <div class="suggestions-results">
              <p>{{ result.sugerencia_1_ChatGPT }}</p>
              <p>{{ result.sugerencia_2_ChatGPT }}</p>
              <p>{{ result.sugerencia_3_ChatGPT }}</p>
          </div>
        </div>


        <div class="analysis-container">
            <h3>Análisis integral de su perfil</h3>
            <p>En la siguiente sección, encontrará un diagrama que ilustra cinco categorías clave identificadas por nuestro sistema como las más relevantes para evaluar sus posibilidades de obtener una visa de turismo a los Estados Unidos. El objetivo es que conozca y comprenda cada uno de estos criterios, representados con calificaciones que varían de 1 a 10. Al analizar sus calificaciones en cada categoría, podrá identificar las áreas en las que necesita mejorar y buscar elementos que lo ayuden a fortalecer su perfil en dichas áreas. De esta manera, podrá aumentar sus probabilidades de éxito en la solicitud de la visa de turismo.</p>
            <div class="analysis-item">
                <div class="analysis-status" id="status-info"></div>
                <div class="analysis-chart">
                    <div class="circle" id="circle-info"></div>
                </div>
                <div class="analysis-info">
                    <strong>Información demográfica y familiar</strong>
                    <p style="font-size: 0.9em;">Información básica y familiar del solicitante que puede influir en la decisión de otorgar la visa.</p>
                    <strong class="score" id="score-info"></strong>
                </div>
            </div>
        
            <div class="analysis-item">
                <div class="analysis-status" id="status-education"></div>
                <div class="analysis-chart">
                    <div class="circle" id="circle-education"></div>
                </div>
                <div class="analysis-info">
                    <strong>Educación y empleo</strong>
                    <p style="font-size: 0.9em;">Datos relacionados con la educación y empleo del solicitante, que pueden indicar estabilidad laboral y capacidad para mantenerse durante el viaje.</p>
                    <strong class="score" id="score-education"></strong>
                </div>
            </div>
        
            <div class="analysis-item">
                <div class="analysis-status" id="status-assets"></div>
                <div class="analysis-chart">
                    <div class="circle" id="circle-assets"></div>
                </div>
                <div class="analysis-info">
                    <strong>Propiedades y activos</strong>
                    <p style="font-size: 0.9em;">Información sobre propiedades, vehículos e ingresos mensuales del solicitante, lo que puede reflejar solidez económica y vínculos con el país de residencia.</p>
                    <strong class="score" id="score-assets"></strong>
                </div>
            </div>
        
            <div class="analysis-item">
                <div class="analysis-status" id="status-background"></div>
                <div class="analysis-chart">
                    <div class="circle neutro" id="circle-background"></div>
                </div>
                <div class="analysis-info">
                    <strong>Antecedentes y experiencia de viaje</strong>
                    <p style="font-size: 0.9em;">Puntos enfocados en la experiencia de viajes internacionales previos y antecedentes legales del solicitante, para evaluar el riesgo de incumplimiento de las regulaciones migratorias y posibles problemas durante su estancia en el país.</p>
                    <strong class="score" id="score-background"></strong>
                </div>
            </div>
        
            <div class="analysis-item">
                <div class="analysis-status" id="status-confidential"></div>
                <div class="analysis-chart">
                    <div class="circle neutro" id="circle-confidential"></div>
                </div>
                <div class="analysis-info">
                    <strong>Criterios confidenciales</strong>
                    <p style="font-size: 0.9em;">Criterios y datos adicionales que nuestro sistema de evaluación considera que las autoridades migratorias pueden tener en cuenta al evaluar la solicitud de visa, pero que no se revelan públicamente.</p>
                    <strong class="score" id="score-confidential"></strong>
                </div>
            </div>
        </div>
        
        <h2><i class="fa fa-chart-pie"></i> 9. Gráfico de Resultados</h2>
        <div class="chart-container content-margins">
            <canvas id="radarChart"></canvas>
        </div>

        <h3><i class="fa fa-chart-pie"></i>Diagrama de resultados</h3>
        <div class="chart-container content-margins">
            <canvas id="radarChart"></canvas>
        </div>

        

    <footer class="footer-simple">
        <div class="footer-content">
            &copy; 2024 VisaParaTurista.com. Todos los derechos reservados.
        </div>
    </footer>

    <div class="dialog-overlay" id="dialog-overlay">
        <div class="dialog">
            <h3>Editar <span id="dialog-title"></span></h3>
            <form id="edit-form">
                <label for="edit-value">Nuevo valor:</label>
                <input type="text" id="edit-value" name="value" required>
                <input type="hidden" id="edit-field" name="field">
                <input type="hidden" id="edit-id" name="id" value="{{ result.id }}">
                <div class="dialog-buttons">
                    <button type="button" onclick="closeDialog()">Cancelar</button>
                    <button type="submit">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <form id="regenerar-form" action="{{ url_for('regenerar', id=result.id) }}" method="post" style="display: none;">
        <input type="hidden" name="id" value="{{ result.id }}">
        <input type="hidden" name="nombre" value="{{ result.nombre }}">
        <input type="hidden" name="apellidos" value="{{ result.apellidos }}">
        <input type="hidden" name="email" value="{{ result.email }}">
        <input type="hidden" name="telefono" value="{{ result.telefono }}">
        <input type="hidden" name="pais_residencia" value="{{ result.pais_residencia }}">
        <input type="hidden" name="fecha" value="{{ result.fecha }}">
        <input type="hidden" name="edad" value="{{ result.edad }}">
        <input type="hidden" name="estado_civil" value="{{ result.estado_civil }}">
        <input type="hidden" name="hijos" value="{{ result.hijos }}">
        <input type="hidden" name="vivienda" value="{{ result.vivienda }}">
        <input type="hidden" name="profesion" value="{{ result.profesion }}">
        <input type="hidden" name="nivel_educacion" value="{{ result.nivel_educacion }}">
        <input type="hidden" name="tiempo_empleo" value="{{ result.tiempo_empleo }}">
        <input type="hidden" name="propietario" value="{{ result.propietario }}">
        <input type="hidden" name="ingresos" value="{{ result.ingresos }}">
        <input type="hidden" name="impuestos" value="{{ result.impuestos }}">
        <input type="hidden" name="propiedades" value="{{ result.propiedades }}">
        <input type="hidden" name="viajes" value="{{ result.viajes }}">
        <input type="hidden" name="familiares_eeuu" value="{{ result.familiares_eeuu }}">
        <input type="hidden" name="familiares_visa" value="{{ result.familiares_visa }}">
        <input type="hidden" name="visa_negada" value="{{ result.visa_negada }}">
        <input type="hidden" name="antecedentes" value="{{ result.antecedentes }}">
        <input type="hidden" name="enfermedades" value="{{ result.enfermedades }}">
        <input type="hidden" name="visa_otra" value="{{ result.visa_otra }}">
        <input type="hidden" name="problemas_migratorios" value="{{ result.problemas_migratorios }}">
        <input type="hidden" name="nacionalidad" value="{{ result.nacionalidad }}">
        <input type="hidden" name="calificacion" value="{{ result.calificacion }}">
    </form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

    
    <script type="module">
      import { createRadarChart } from '../graficos/radarChart.js';  // Ajusta el path según la ubicación del archivo

      const ctx = document.getElementById('radarChart').getContext('2d');
      const data = {
          labels: ['Información demográfica', 'Educación', 'Propiedades', 'Antecedentes', 'Confidenciales'],
          datasets: [{
              data: [7.5, 8.0, 6.5, 7.0, 5.0],
              backgroundColor: 'rgba(41, 128, 185, 0.2)',
              borderColor: 'rgba(41, 128, 185, 1)',
              borderWidth: 3,
              pointBackgroundColor: 'rgba(41, 128, 185, 1)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgba(41, 128, 185, 1)'
          }]
      };

      createRadarChart(ctx, data);  //
        // Funciones para abrir y cerrar diálogos
        function openDialog(field, value) {
            document.getElementById('dialog-title').innerText = field.charAt(0).toUpperCase() + field.slice(1);
            document.getElementById('edit-value').value = value;
            document.getElementById('edit-field').value = field;
            document.getElementById('dialog-overlay').classList.add('active');
        }

        function closeDialog() {
            document.getElementById('dialog-overlay').classList.remove('active');
        }

        // Manejo del formulario de edición 
        //ESTA EDICIÓN DE INFORMACIÓN SE NECESITARÁ ?
        document.getElementById('edit-form').addEventListener('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(event.target);

            fetch('/update', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(formData.get('field') + '-span').innerText = formData.get('value');
                    closeDialog();
                } else {
                    alert('Error al actualizar el campo');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar el campo');
            });
        });

        // Funciones para abrir y cerrar el diálogo de eliminación
        function openDeleteDialog() {
            document.getElementById('delete-dialog-overlay').classList.add('active');
        }

        function closeDeleteDialog() {
            document.getElementById('delete-dialog-overlay').classList.remove('active');
        }

        // Manejo del formulario de eliminación
        //ESTA EDICIÓN DE INFORMACIÓN SE NECESITARÁ ?
        document.getElementById('delete-form').addEventListener('submit', function(event) {
            event.preventDefault();
            var confirmDelete = document.getElementById('confirm-delete').value;
            if (confirmDelete === 'DELETE') {
                var formData = new FormData(event.target);
                fetch('/delete', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/results';
                    } else {
                        alert('Error al eliminar el registro');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar el registro');
                });
            } else {
                alert('Por favor, escribe "DELETE" para confirmar.');
            }
        });

        // Eliminar un registro con confirmación
        function deleteRecord(recordId) {
            const confirmDelete = prompt("Type 'DELETE' to confirm the deletion:");

            if (confirmDelete !== 'DELETE') {
                alert("Deletion not confirmed.");
                return;
            }

            fetch('/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: recordId,
                    'confirm-delete': confirmDelete
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Record deleted successfully.");
                    // Optionally, refresh the page or update the UI
                } else {
                    alert("Failed to delete record: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }

        // Inicialización de gráficos y actualización de la UI al cargar la página

        document.addEventListener('DOMContentLoaded', function() {
            var probability = result.probabilidad ;
            var probabilityBarInner = document.querySelector('.probability-bar-inner');
            probabilityBarInner.style.width = probability + '%';

            function calculateAverage(scores) {
                for (var i = 0; i < scores.length; i++) {
                    if (isNaN(scores[i])) {
                        return NaN;
                    }
                }
                var sum = scores.reduce((a, b) => a + b, 0);
                return (sum / scores.length).toFixed(2);
            }

            function calculateTableAverage(scores) {
                scores = scores.map(val => parseFloat(val));
                for (var i = 0; i < scores.length; i++) {
                    if (isNaN(scores[i])) {
                        return NaN;
                    }
                }
                var sum = scores.reduce((a, b) => a + b, 0);
                return (sum / scores.length).toFixed(2);
            }

            function updateStatusAndCircle(score, elementId, statusId) {
                if (isNaN(score) || score === null) {
                    document.getElementById(elementId).innerHTML = `<span>N/A</span>`;
                    document.getElementById(statusId).innerText = 'N/A';
                    document.getElementById(statusId).className = 'analysis-status';
                    document.getElementById(elementId).className = 'circle';
                    document.getElementById(elementId).style.background = 'conic-gradient(lightgray 0% 360deg)';
                    return;
                }

                var status = 'POSITIVO';
                var className = 'positivo';
                if (score < 3) {
                    status = 'NEGATIVO';
                    className = 'negativo';
                } else if (score < 6.5) {
                    status = 'NEUTRO';
                    className = 'neutro';
                }

                var degree = (score / 10) * 360;
                var background = `conic-gradient(green 0% ${degree}deg, lightgray ${degree}deg 360deg)`;
                if (className === 'neutro') {
                    background = `conic-gradient(#ff9800 0% ${degree}deg, lightgray ${degree}deg 360deg)`;
                } else if (className === 'negativo') {
                    background = `conic-gradient(#f44336 0% ${degree}deg, lightgray ${degree}deg 360deg)`;
                }

                document.getElementById(elementId).innerHTML = `<span>${score}</span>`;
                document.getElementById(statusId).innerText = status;
                document.getElementById(statusId).className = `analysis-status ${className}`;
                document.getElementById(elementId).className = `circle ${className}`;
                document.getElementById(elementId).style.background = background;
            }

            function updateResultBox(score, elementId) {
                if (isNaN(score)) {
                    document.getElementById(elementId).innerText = 'Resultado: N/A';
                    document.getElementById(elementId).className = 'result-box negativo';
                    return;
                }

                var status = 'POSITIVO';
                var className = 'positivo';
                if (score < 3) {
                    status = 'NEGATIVO';
                    className = 'negativo';
                } else if (score < 6.5) {
                    status = 'NEUTRO';
                    className = 'neutro';
                }

                document.getElementById(elementId).innerText = `Resultado: ${score} - ${status}`;
                document.getElementById(elementId).className = `result-box ${className}`;
            }

            var demographyScores = [
                parseFloat("{{ result.calificacion_pais_residencia_ChatGPT }}"),
                parseFloat("{{ result.calificacion_edad_ChatGPT }}"),
                parseFloat("{{ result.calificacion_estado_civil_ChatGPT }}"),
                parseFloat("{{ result.calificacion_hijos_ChatGPT }}"),
                parseFloat("{{ result.calificacion_vivienda_ChatGPT }}")
            ].map(val => isNaN(val) ? NaN : val);

            var educationScores = [
                parseFloat("{{ result.calificacion_profesion_ChatGPT }}"),
                parseFloat("{{ result.calificacion_nivel_educacion_ChatGPT }}"),
                parseFloat("{{ result.calificacion_tiempo_empleo_ChatGPT }}")
            ].map(val => isNaN(val) ? NaN : val);

            var assetsScores = [
                parseFloat("{{ result.calificacion_propietario_ChatGPT }}"),
                parseFloat("{{ result.calificacion_ingresos_ChatGPT }}"),
                parseFloat("{{ result.calificacion_impuestos_ChatGPT }}"),
                parseFloat("{{ result.calificacion_propiedades_ChatGPT }}")
            ].map(val => isNaN(val) ? NaN : val);

            var backgroundScores = [
                parseFloat("{{ result.calificacion_viajes_ChatGPT }}"),
                parseFloat("{{ result.calificacion_familiares_eeuu_ChatGPT }}"),
                parseFloat("{{ result.calificacion_familiares_visa_ChatGPT }}"),
                parseFloat("{{ result.calificacion_visa_negada_ChatGPT }}"),
                parseFloat("{{ result.calificacion_problemas_migratorios_ChatGPT }}"),
                parseFloat("{{ result.calificacion_visa_otra_ChatGPT }}"),
                parseFloat("{{ result.calificacion_enfermedades_ChatGPT }}"),
                parseFloat("{{ result.calificacion_antecedentes_ChatGPT }}")
            ].map(val => isNaN(val) ? NaN : val);

            var confidentialScores = [
                parseFloat("{{ result.calificacion_nacionalidad_ChatGPT }}"),
                parseFloat("{{ result.calificacion }}")
            ].map(val => isNaN(val) ? NaN : val);

            var averageDemography = calculateAverage(demographyScores);
            var averageEducation = calculateAverage(educationScores);
            var averageAssets = calculateAverage(assetsScores);
            var averageBackground = calculateAverage(backgroundScores);
            var averageConfidential = calculateAverage(confidentialScores);

            var demographyTableScores = [
                "{{ result.calificacion_pais_residencia_ChatGPT }}",
                "{{ result.calificacion_edad_ChatGPT }}",
                "{{ result.calificacion_estado_civil_ChatGPT }}",
                "{{ result.calificacion_hijos_ChatGPT }}",
                "{{ result.calificacion_vivienda_ChatGPT }}"
            ];

            var educationTableScores = [
                "{{ result.calificacion_profesion_ChatGPT }}",
                "{{ result.calificacion_nivel_educacion_ChatGPT }}",
                "{{ result.calificacion_tiempo_empleo_ChatGPT }}"
            ];

            var assetsTableScores = [
                "{{ result.calificacion_propietario_ChatGPT }}",
                "{{ result.calificacion_ingresos_ChatGPT }}",
                "{{ result.calificacion_impuestos_ChatGPT }}",
                "{{ result.calificacion_propiedades_ChatGPT }}"
            ];

            var backgroundTableScores = [
                "{{ result.calificacion_viajes_ChatGPT }}",
                "{{ result.calificacion_familiares_eeuu_ChatGPT }}",
                "{{ result.calificacion_familiares_visa_ChatGPT }}",
                "{{ result.calificacion_visa_negada_ChatGPT }}"
            ];

            var confidentialTableScores = [
                "{{ result.calificacion_antecedentes_ChatGPT }}",
                "{{ result.calificacion_enfermedades_ChatGPT }}",
                "{{ result.calificacion_visa_otra_ChatGPT }}",
                "{{ result.calificacion_problemas_migratorios_ChatGPT }}",
                "{{ result.calificacion_nacionalidad_ChatGPT }}",
                "{{ result.calificacion }}"
            ];

            var averageDemographyTable = calculateTableAverage(demographyTableScores);
            var averageEducationTable = calculateTableAverage(educationTableScores);
            var averageAssetsTable = calculateTableAverage(assetsTableScores);
            var averageBackgroundTable = calculateTableAverage(backgroundTableScores);
            var averageConfidentialTable = calculateTableAverage(confidentialTableScores);

            updateStatusAndCircle(averageDemography, 'circle-info', 'status-info');
            updateStatusAndCircle(averageEducation, 'circle-education', 'status-education');
            updateStatusAndCircle(averageAssets, 'circle-assets', 'status-assets');
            updateStatusAndCircle(averageBackground, 'circle-background', 'status-background');
            updateStatusAndCircle(averageConfidential, 'circle-confidential', 'status-confidential');

            updateResultBox(averageDemographyTable, 'result-info-table');
            updateResultBox(averageEducationTable, 'result-education-table');
            updateResultBox(averageAssetsTable, 'result-assets-table');
            updateResultBox(averageBackgroundTable, 'result-background-table');
            updateResultBox(averageConfidentialTable, 'result-confidential-table');

            document.getElementById('score-info').innerText = averageDemography;
            document.getElementById('score-education').innerText = averageEducation;
            document.getElementById('score-assets').innerText = averageAssets;
            document.getElementById('score-background').innerText = averageBackground;
            document.getElementById('score-confidential').innerText = averageConfidential;

            // Radar Chart
            const ctx = document.getElementById('radarChart').getContext('2d');
            const data = {
                labels: ['Información demográfica y familiar', 'Educación y empleo', 'Propiedades y activos', 'Antecedentes y experiencia de viaje', 'Criterios confidenciales'],
                datasets: [{
                    data: [averageDemography, averageEducation, averageAssets, averageBackground, averageConfidential],
                    backgroundColor: 'rgba(41, 128, 185, 0.2)',
                    borderColor: 'rgba(41, 128, 185, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(41, 128, 185, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(41, 128, 185, 1)'
                }]
            };
            const config = {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 10,
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.2)',
                                lineWidth: 2
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 2
                            },
                            pointLabels: {
                                color: '#34495e',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                backdropColor: 'rgba(255, 255, 255, 0.2)',
                                color: '#34495e',
                                beginAtZero: true,
                                stepSize: 2,
                                showLabelBackdrop: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ecf0f1',
                            bodyColor: '#ecf0f1',
                            borderColor: 'rgba(41, 128, 185, 1)',
                            borderWidth: 1
                        }
                    }
                }
            };

            new Chart(ctx, config);
        });

 
// Conectar con el servidor Flask-SocketIO una vez al cargar la página
const socket = io();

// Función para el efecto de escritura
function typeWriter(text, element, delay, callback) {
    let i = 0;
    element.textContent = '';
    
    function type() {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            setTimeout(type, delay);
        } else if (callback) {
            setTimeout(callback, 5000); // Espera 5 segundos antes de reiniciar el texto
        }
    }
    type();
}

// Función para animar el texto
function animateText() {
    const progressText = document.getElementById('message-overlay');
    typeWriter('Re-procesando datos con IA.', progressText, 100, () => {
        progressText.style.transition = 'opacity 0.5s';
        progressText.style.opacity = 0;
        setTimeout(() => {
            progressText.style.opacity = 1;
            animateText();
        }, 500);
    });
}

// Escuchar eventos de progreso emitidos desde el servidor para regenerar
socket.on('progressregenerar', function (data) {
    const progressBar = document.getElementById('progress-regenerar-bar');
    const { progressregenerar } = data;

    progressBar.style.width = progressregenerar + '%'; // Actualizar la barra de progreso

    // Mostrar el progreso en la consola (opcional para depuración)
    console.log(`Progreso: ${progressregenerar}%`);

    // Ocultar el overlay cuando el progreso llegue al 100%
    if (progressregenerar >= 100) {
        document.getElementById('processing-overlay').style.display = 'none';
    }
});

document.querySelector('.buttons button[type="button"]').addEventListener('click', function(event) {
    event.preventDefault();

    const processingOverlay = document.getElementById('processing-overlay');
    const progressBar = document.getElementById('progress-regenerar-bar');
    
    processingOverlay.style.display = 'flex';  // Mostrar la caja flotante
    animateText();  // Iniciar la animación del texto

    // Iniciar la barra de progreso
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2; // Incremento para completar en 40 segundos
        progressBar.style.width = progress + '%';
        
        if (progress >= 100) {
            clearInterval(progressInterval);
            processingOverlay.style.display = 'none'; // Ocultar el overlay cuando se completa
        }
    }, 1000);

    const form = document.getElementById('regenerar-form');
    const formData = new FormData(form); // Crear FormData del formulario

    // Enviar el formulario a través de AJAX para evitar recarga de página
    $.ajax({
        url: form.action, // URL de acción del formulario
        method: form.method, // Método del formulario (POST en este caso)
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            console.log('Formulario enviado correctamente:', response);
            if (response.redirect_url) {
                window.location.href = response.redirect_url;
            }
        },
        error: function(error) {
            console.error('Error al enviar el formulario:', error);
        }
    });
});

const puppeteer = require('puppeteer');

async function generatePDF(url, outputPath) {
    const browser = await puppeteer.launch();
    const page = await browser.newPage();
    await page.goto(url, { waitUntil: 'networkidle2' });
    await page.pdf({ path: outputPath, format: 'A4' });
    await browser.close();
}

const url = process.argv[2];
const outputPath = process.argv[3];

generatePDF(url, outputPath).catch(error => {
    console.error(error);
    process.exit(1);
});

</script>
</body>
</html>
